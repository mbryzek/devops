#!/usr/bin/env ruby

require 'json'
require 'open3'

load File.join(File.dirname(__FILE__), '../lib/common.rb')
load File.join(File.dirname(__FILE__), '../lib/generated/bryzek_platform_invariants_v0_client.rb')

ENDPOINTS = [
  { name: "Acumen", url: "https://api.trueacumen.com", app: "acumen" },
  { name: "Platform", url: "https://idempotent.io", app: "platform" }
]

def fetch_invariants(endpoint, devops_token)
  headers = { "X-Devops-Token" => devops_token }
  client = Com::Bryzek::Platform::Invariants::V0::Client.new(endpoint[:url], default_headers: headers)
  result = client.invariant_results.get_json
  { service_name: endpoint[:name], result: result }
rescue => e
  puts "  ERROR: #{e.message}"
  nil
end

def print_failures(result)
  result.non_zero.each do |inv|
    puts "  - #{inv.name}"
    puts "    Count: #{inv.count}"
    if inv.examples && !inv.examples.empty?
      puts "    Examples:"
      inv.examples.take(3).each do |ex|
        puts "      * #{ex}"
      end
      if inv.examples.length > 3
        puts "      ... and #{inv.examples.length - 3} more"
      end
    end
  end

  result.error.each do |inv|
    puts "  - #{inv.name}"
    puts "    Error: #{inv.error || 'Unknown error'}"
  end
end

puts ""
puts Util.underline("Checking Invariants")
puts ""

results = ENDPOINTS.map do |endpoint|
  Thread.new do
    print "Fetching #{endpoint[:name]}..."
    $stdout.flush
    vars = EnvironmentVariables.load(endpoint[:app], "production")
    devops_token = vars["DEVOPS_TOKEN"]
    if devops_token.nil? || devops_token.empty?
      puts " ERROR: DEVOPS_TOKEN not configured for #{endpoint[:app]}"
      { endpoint: endpoint, data: nil }
    else
      data = fetch_invariants(endpoint, devops_token)
      puts " done"
      { endpoint: endpoint, data: data }
    end
  end
end.map(&:value)

puts ""

all_passed = true
results.sort_by { |r| r[:endpoint][:name] }.each do |r|
  endpoint = r[:endpoint]
  data = r[:data]

  if data.nil?
    puts Util.underline("#{endpoint[:name]}: UNREACHABLE")
    all_passed = false
  else
    result = data[:result]
    total_count = result.success.length + result.non_zero.length + result.error.length
    failure_count = result.non_zero.length + result.error.length

    if failure_count == 0
      puts "#{endpoint[:name]}: #{total_count} invariants passed"
    else
      puts Util.underline("#{endpoint[:name]}: #{failure_count} FAILURES (#{total_count} total)")
      print_failures(result)
      all_passed = false
    end
  end
  puts ""
end

if all_passed
  puts "All invariants passed"
  exit 0
else
  puts "Some invariants failed"
  exit 1
end
