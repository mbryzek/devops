#!/usr/bin/env ruby

# k8s-migrate: Run database migrations as a Kubernetes Job
#
# Usage:
#   k8s-migrate [--app APP] [--version VERSION] [--wait]
#
# Examples:
#   k8s-migrate                                    # Run migration for current app (inferred from directory)
#   k8s-migrate --app platform                     # Run migration job
#   k8s-migrate --app platform --version v1.2.3   # Specific version
#   k8s-migrate --app platform --wait             # Wait for completion
#
# Prerequisites:
#   - kubectl configured with cluster access
#   - Migration Docker image built and pushed
#   - DB credentials secret created (via k8s-secrets)

load File.join(File.dirname(__FILE__), '../lib/common.rb')

args = Args.parse(ARGV, ["app"])

SCRIPT_DIR = File.dirname(__FILE__)
K8S_DIR = File.join(SCRIPT_DIR, '../k8s')

# Kubernetes namespace
K8S_NAMESPACE = args.namespace || 'bryzek-production'

# Version defaults to latest
version = args.version || 'latest'

# Timeout defaults to 300 seconds
timeout = args.timeout || 300

# Generate unique job suffix with timestamp
job_suffix = Time.now.strftime('%Y%m%d-%H%M%S')

puts ""
puts "=" * 60
puts "Running Database Migration"
puts "=" * 60
puts "  App:       #{args.app}"
puts "  Version:   #{version}"
puts "  Job:       #{args.app}-migration-#{job_suffix}"
puts "  Namespace: #{K8S_NAMESPACE}"
puts "=" * 60
puts ""

# Generate migration manifest
puts "Generating migration manifest..."
env_vars = "APP=#{args.app} VERSION=#{version} JOB_SUFFIX=#{job_suffix}"
env_vars += " K8S_NAMESPACE=#{K8S_NAMESPACE}" if args.namespace
pkl_file = File.join(K8S_DIR, 'jobs', 'db-migration.pkl')
manifest_file = "/tmp/#{args.app}-migration-#{job_suffix}.yaml"

cmd = "cd #{K8S_DIR} && #{env_vars} pkl eval #{pkl_file}"
manifest = `#{cmd} 2>&1`

unless $?.success?
  Util.exit_with_error("Error generating manifest:\n#{manifest}")
end

File.write(manifest_file, manifest)
puts "Manifest written to: #{manifest_file}"
puts ""

# Apply the job
puts "Applying migration job..."
Util.run("kubectl apply -f #{manifest_file}")

job_name = "#{args.app}-migration-#{job_suffix}"

puts ""
puts "Migration job created: #{job_name}"
puts ""

if args.wait
  puts "Waiting for job completion (timeout: #{timeout}s)..."
  puts ""

  # Wait for job completion
  success = system("kubectl wait --for=condition=complete --timeout=#{timeout}s job/#{job_name} -n #{K8S_NAMESPACE}")

  # Get job logs regardless of success/failure
  puts ""
  puts "=" * 60
  puts "Migration Logs"
  puts "=" * 60
  system("kubectl logs job/#{job_name} -n #{K8S_NAMESPACE}")

  if success
    puts ""
    puts "=" * 60
    puts "Migration completed successfully!"
    puts "=" * 60
  else
    # Check if job failed vs timeout
    job_status = `kubectl get job #{job_name} -n #{K8S_NAMESPACE} -o jsonpath='{.status.conditions[?(@.type=="Failed")].status}'`.strip

    if job_status == "True"
      puts ""
      puts "=" * 60
      puts "ERROR: Migration failed!"
      puts "=" * 60
      exit 1
    else
      puts ""
      puts "=" * 60
      puts "WARNING: Timed out waiting for migration"
      puts "Check status with: kubectl get job #{job_name} -n #{K8S_NAMESPACE}"
      puts "=" * 60
      exit 1
    end
  end
else
  puts "Job started. To monitor:"
  puts "  kubectl get job #{job_name} -n #{K8S_NAMESPACE}"
  puts "  kubectl logs job/#{job_name} -n #{K8S_NAMESPACE} -f"
end

# Clean up manifest file
FileUtils.rm_f(manifest_file)
