#!/usr/bin/env ruby

# Inspects running nodes and shuts down extra instances.
# Extra = apps running on job server nodes that aren't that node's job server app.
# Only removes if at least 2 instances of the app would remain.
#
# Usage: ./bin/cleanup-extras [--whisper]
#   --whisper: Only output when there's work to do

load File.join(File.dirname(__FILE__), '../lib/common.rb')
load File.join(File.dirname(__FILE__), '../lib/localhost/digital_ocean.rb')

DRAIN_WAIT_SECONDS = 10
LB_REMOVAL_POLL_TIMEOUT = 30

$whisper = ARGV.include?('--whisper')

def log(msg = "")
  puts msg unless $whisper
end

# Load global nodes
global_nodes_path = File.join(File.dirname(__FILE__), "../dist/nodes.json")
if !File.exist?(global_nodes_path)
  Util.exit_with_error("Nodes config not found at #{global_nodes_path}. Run ./generate-json.rb first.")
end
global_nodes = JSON.parse(IO.read(global_nodes_path))['nodes'].map { |n| n['uri'] }

# Inspect current state
inspector = NodeInspector.new.discover

log
log Util.underline("Inspecting nodes")
inspector.print_details unless $whisper

# Find extra instances
extras = inspector.extra_instances

if extras.empty?
  log
  log "No extra instances found. Nothing to clean up."
  log
  exit 0
end

# Clean up extras
extras.each do |app_name, node_uris|
  do_client = DigitalOcean::Client.new(app_name, node_ips: global_nodes)

  node_uris.each do |node_uri|
    puts ""
    puts "  Draining #{node_uri} from #{app_name} load balancer..."
    do_client.drain_and_wait(node_uri, drain_wait: DRAIN_WAIT_SECONDS, max_poll: LB_REMOVAL_POLL_TIMEOUT)

    puts "  Stopping #{app_name} on #{node_uri}"
    cmd = "ssh root@#{node_uri} './deploy/kill.rb --app #{app_name}'"
    system(cmd)
  end
end

if !$whisper
  puts ""
  puts "Cleanup complete. Final state:"
  NodeInspector.new.discover.print_details
  puts ""
end
