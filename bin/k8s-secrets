#!/usr/bin/env ruby

# k8s-secrets: Sync environment secrets from git-crypt to Kubernetes
#
# Usage:
#   k8s-secrets [--app APP] [--env ENV] [--dry-run]
#
# Examples:
#   k8s-secrets                                    # Preview secrets for current app (dry-run)
#   k8s-secrets --app platform                     # Apply secrets to cluster
#   k8s-secrets --app platform --env development   # Use development environment
#   k8s-secrets --app platform --dry-run           # Preview without applying
#
# Prerequisites:
#   - kubectl configured with cluster access
#   - git-crypt unlocked in env/ repository

load File.join(File.dirname(__FILE__), '../lib/common.rb')

require 'yaml'

args = Args.parse(ARGV, ["app"])

# Kubernetes namespace
K8S_NAMESPACE = args.namespace || 'bryzek-production'

# Load environment variables using the existing EnvironmentVariables class
puts "Loading environment variables for #{args.app} (#{args.env})..."
vars_obj = EnvironmentVariables.load(args.app, args.env)

# Convert to hash by parsing the JSON serialization
vars = JSON.parse(vars_obj.serialize("json"))

if vars.empty?
  Util.exit_with_error("No environment variables found")
end

puts "Found #{vars.size} environment variables"
puts ""

# Generate Kubernetes Secret manifest
secret_name = "#{args.app}-secrets"
config_name = "#{args.app}-config"

# Separate sensitive vs non-sensitive config
# Convention: Variables starting with CONF_ are config, others are secrets
config_vars = vars.select { |k, _| k.start_with?('CONF_') }
secret_vars = vars.reject { |k, _| k.start_with?('CONF_') }

# Also add database credentials secret if database config exists
db_vars = {}
%w[DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD DATABASE_URL].each do |key|
  db_vars[key] = vars[key] if vars[key]
end

# Generate Secret YAML
secret_manifest = {
  'apiVersion' => 'v1',
  'kind' => 'Secret',
  'metadata' => {
    'name' => secret_name,
    'namespace' => K8S_NAMESPACE,
    'labels' => {
      'app' => args.app,
      'app.kubernetes.io/name' => args.app
    }
  },
  'type' => 'Opaque',
  'stringData' => secret_vars
}

# Generate ConfigMap YAML
configmap_manifest = {
  'apiVersion' => 'v1',
  'kind' => 'ConfigMap',
  'metadata' => {
    'name' => config_name,
    'namespace' => K8S_NAMESPACE,
    'labels' => {
      'app' => args.app,
      'app.kubernetes.io/name' => args.app
    }
  },
  'data' => config_vars
}

# Generate DB credentials Secret if we have database vars
db_secret_manifest = nil
unless db_vars.empty?
  db_secret_manifest = {
    'apiVersion' => 'v1',
    'kind' => 'Secret',
    'metadata' => {
      'name' => "#{args.app}-db-credentials",
      'namespace' => K8S_NAMESPACE,
      'labels' => {
        'app' => args.app,
        'app.kubernetes.io/name' => args.app
      }
    },
    'type' => 'Opaque',
    'stringData' => db_vars
  }
end

# Output summary
puts "=" * 60
puts "Kubernetes Secrets Summary"
puts "=" * 60
puts "  Namespace:    #{K8S_NAMESPACE}"
puts "  Secret:       #{secret_name} (#{secret_vars.size} vars)"
puts "  ConfigMap:    #{config_name} (#{config_vars.size} vars)"
puts "  DB Secret:    #{args.app}-db-credentials (#{db_vars.size} vars)" if db_secret_manifest
puts "=" * 60
puts ""

# Show variable names (not values!)
puts "Secret variables (#{secret_name}):"
secret_vars.keys.sort.each { |k| puts "  - #{k}" }
puts ""

puts "ConfigMap variables (#{config_name}):"
config_vars.keys.sort.each { |k| puts "  - #{k}" }
puts ""

if db_secret_manifest
  puts "DB Credentials (#{args.app}-db-credentials):"
  db_vars.keys.sort.each { |k| puts "  - #{k}" }
  puts ""
end

if args.dry_run
  puts "DRY RUN - Use without --dry-run to apply secrets to cluster"
  puts ""
  puts "Preview (Secret):"
  puts secret_manifest.to_yaml
else
  puts "Applying to Kubernetes cluster..."

  # Write manifests to temp files
  tmp_dir = "/tmp/k8s-secrets-#{args.app}"
  FileUtils.mkdir_p(tmp_dir)

  secret_file = File.join(tmp_dir, "secret.yaml")
  configmap_file = File.join(tmp_dir, "configmap.yaml")

  File.write(secret_file, secret_manifest.to_yaml)
  File.write(configmap_file, configmap_manifest.to_yaml)

  # Apply Secret
  puts "  Applying #{secret_name}..."
  Util.run("kubectl apply -f #{secret_file}")

  # Apply ConfigMap
  puts "  Applying #{config_name}..."
  Util.run("kubectl apply -f #{configmap_file}")

  # Apply DB credentials if present
  if db_secret_manifest
    db_file = File.join(tmp_dir, "db-secret.yaml")
    File.write(db_file, db_secret_manifest.to_yaml)
    puts "  Applying #{args.app}-db-credentials..."
    Util.run("kubectl apply -f #{db_file}")
  end

  # Clean up
  FileUtils.rm_rf(tmp_dir)

  puts ""
  puts "Secrets applied successfully!"
end
