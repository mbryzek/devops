#!/usr/bin/env ruby

# k8s-deploy: Deploy application to Kubernetes with rolling updates
#
# Usage:
#   k8s-deploy [--app APP] [--version VERSION] [--wait] [--dry-run]
#
# Examples:
#   k8s-deploy                                    # Deploy current app (inferred from directory)
#   k8s-deploy --app platform                     # Deploy latest tag
#   k8s-deploy --app platform --version v1.2.3   # Deploy specific version
#   k8s-deploy --app platform --wait             # Wait for rollout
#
# Prerequisites:
#   - kubectl configured with cluster access
#   - Docker image built and pushed (via k8s-build)
#   - Secrets configured (via k8s-secrets)

load File.join(File.dirname(__FILE__), '../lib/common.rb')

args = Args.parse(ARGV, ["app"])

SCRIPT_DIR = File.dirname(__FILE__)
K8S_DIR = File.join(SCRIPT_DIR, '../k8s')

# Kubernetes namespace
K8S_NAMESPACE = args.namespace || 'bryzek-production'

# Version - fetch latest tag if not specified
version = args.version
if version.nil? || version.empty?
  version = AppConfig.latest_tag(args.app)
  puts "Using latest tag: #{version}"
end

# Timeout defaults to 600 seconds
timeout = args.timeout || 600

puts ""
puts "=" * 60
puts "Deploying to Kubernetes"
puts "=" * 60
puts "  App:       #{args.app}"
puts "  Version:   #{version}"
puts "  Namespace: #{K8S_NAMESPACE}"
puts "  Dry Run:   #{args.dry_run ? 'Yes' : 'No'}"
puts "=" * 60
puts ""

# Generate manifests
puts "Generating Kubernetes manifests..."
app_config_file = File.join(K8S_DIR, 'apps', "#{args.app}.pkl")
template_file = File.join(K8S_DIR, 'templates', 'scala-play-app.pkl')
manifest_file = "/tmp/#{args.app}-deploy-#{version}.yaml"

unless File.exist?(app_config_file)
  Util.exit_with_error("App config not found: #{app_config_file}")
end

unless File.exist?(template_file)
  Util.exit_with_error("Template not found: #{template_file}")
end

# Read app config to get port
config_output = `cd #{K8S_DIR} && pkl eval -f json apps/#{args.app}.pkl 2>/dev/null`
config = JSON.parse(config_output) rescue {}
app_port = config["appPort"] || 9000

# Build env vars for template
env_vars = "APP=#{args.app} PORT=#{app_port} VERSION=#{version}"
env_vars += " K8S_NAMESPACE=#{K8S_NAMESPACE}" if args.namespace

cmd = "cd #{K8S_DIR} && #{env_vars} pkl eval #{template_file}"
manifest = `#{cmd} 2>&1`

unless $?.success?
  Util.exit_with_error("Error generating manifest:\n#{manifest}")
end

File.write(manifest_file, manifest)
puts "Manifest written to: #{manifest_file}"
puts ""

if args.dry_run
  puts "DRY RUN - Manifest contents:"
  puts "-" * 60
  puts manifest
  puts "-" * 60
  FileUtils.rm_f(manifest_file)
  exit 0
end

# Check if namespace exists
namespace_exists = system("kubectl get namespace #{K8S_NAMESPACE} > /dev/null 2>&1")
unless namespace_exists
  puts "Creating namespace: #{K8S_NAMESPACE}"
  Util.run("kubectl create namespace #{K8S_NAMESPACE}")
end

# Apply manifests
puts "Applying Kubernetes manifests..."
Util.run("kubectl apply -f #{manifest_file}")

puts ""
puts "Manifests applied successfully!"

if args.wait
  puts ""
  puts "Waiting for rollout to complete..."

  # Wait for Deployment rollout
  deployment_name = "#{args.app}-web"
  puts "  Waiting for Deployment #{deployment_name}..."
  deployment_success = system("kubectl rollout status deployment/#{deployment_name} -n #{K8S_NAMESPACE} --timeout=#{timeout}s")

  # Wait for StatefulSet rollout
  statefulset_name = "#{args.app}-job"
  puts "  Waiting for StatefulSet #{statefulset_name}..."
  statefulset_success = system("kubectl rollout status statefulset/#{statefulset_name} -n #{K8S_NAMESPACE} --timeout=#{timeout}s")

  if deployment_success && statefulset_success
    puts ""
    puts "=" * 60
    puts "Deployment completed successfully!"
    puts "=" * 60
  else
    puts ""
    puts "=" * 60
    puts "WARNING: Rollout did not complete within timeout"
    puts ""
    puts "Check status:"
    puts "  kubectl get pods -n #{K8S_NAMESPACE} -l app=#{args.app}"
    puts "  kubectl describe deployment #{deployment_name} -n #{K8S_NAMESPACE}"
    puts "=" * 60
    exit 1
  end
end

# Show deployment status
puts ""
puts "Deployment Status:"
puts "-" * 60
system("kubectl get deployment #{args.app}-web -n #{K8S_NAMESPACE}")
system("kubectl get statefulset #{args.app}-job -n #{K8S_NAMESPACE}")
puts ""
puts "Pods:"
system("kubectl get pods -n #{K8S_NAMESPACE} -l app=#{args.app}")

# Clean up manifest file
FileUtils.rm_f(manifest_file)

puts ""
puts "=" * 60
puts "Deployment Summary"
puts "=" * 60
puts "  App:     #{args.app}"
puts "  Version: #{version}"
puts "  Status:  Deployed"
puts ""
puts "Useful commands:"
puts "  kubectl logs -n #{K8S_NAMESPACE} -l app=#{args.app},tier=web -f"
puts "  kubectl logs -n #{K8S_NAMESPACE} -l app=#{args.app},tier=job -f"
puts "  kubectl get pods -n #{K8S_NAMESPACE} -l app=#{args.app} -w"
puts "=" * 60
