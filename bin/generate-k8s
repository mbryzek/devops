#!/usr/bin/env ruby

# generate-k8s: Generate Kubernetes manifests from Pkl files
#
# Usage:
#   generate-k8s --app APP [--version VERSION] [--output DIR]
#
# Examples:
#   generate-k8s --app platform
#   generate-k8s --app platform --version v1.2.3
#   generate-k8s --app platform --output /tmp/manifests

require 'optparse'
require 'fileutils'

SCRIPT_DIR = File.dirname(__FILE__)
K8S_DIR = File.join(SCRIPT_DIR, '../k8s')
DEFAULT_OUTPUT_DIR = File.join(SCRIPT_DIR, '../dist/k8s')

# Valid applications
VALID_APPS = %w[platform acumen]

options = {
  version: ENV['VERSION'] || 'latest',
  output: DEFAULT_OUTPUT_DIR
}

OptionParser.new do |opts|
  opts.banner = "Usage: generate-k8s --app APP [options]"

  opts.on("--app APP", "Application name (#{VALID_APPS.join(', ')})") do |app|
    options[:app] = app
  end

  opts.on("--version VERSION", "Docker image version tag (default: latest or VERSION env var)") do |v|
    options[:version] = v
  end

  opts.on("--output DIR", "Output directory (default: #{DEFAULT_OUTPUT_DIR})") do |dir|
    options[:output] = dir
  end

  opts.on("--job-suffix SUFFIX", "Suffix for job name (used by db-migration)") do |suffix|
    options[:job_suffix] = suffix
  end

  opts.on("-h", "--help", "Show this help") do
    puts opts
    exit
  end
end.parse!

# Validate app
unless options[:app]
  puts "Error: --app is required"
  puts "Valid apps: #{VALID_APPS.join(', ')}"
  exit 1
end

unless VALID_APPS.include?(options[:app])
  puts "Error: Invalid app '#{options[:app]}'"
  puts "Valid apps: #{VALID_APPS.join(', ')}"
  exit 1
end

# Create output directory
FileUtils.mkdir_p(options[:output])

# Build environment for pkl
env = {
  'VERSION' => options[:version]
}
env['JOB_SUFFIX'] = options[:job_suffix] if options[:job_suffix]

def run_pkl(pkl_file, output_file, env)
  env_args = env.map { |k, v| "#{k}=#{v}" }.join(' ')
  cmd = "cd #{K8S_DIR} && #{env_args} pkl eval #{pkl_file}"

  puts "Generating: #{output_file}"
  output = `#{cmd} 2>&1`

  if $?.success?
    File.write(output_file, output)
    puts "  -> Success"
  else
    puts "  -> Error:"
    puts output.lines.map { |l| "     #{l}" }.join
    exit 1
  end
end

app = options[:app]
version = options[:version]

# Generate app manifest
app_pkl = File.join('apps', "#{app}.pkl")
app_output = File.join(options[:output], "#{app}.yaml")
run_pkl(app_pkl, app_output, env)

# If job suffix is specified, also generate migration job
if options[:job_suffix]
  env['APP'] = app
  migration_pkl = File.join('jobs', 'db-migration.pkl')
  migration_output = File.join(options[:output], "#{app}-migration.yaml")
  run_pkl(migration_pkl, migration_output, env)
end

puts ""
puts "Manifests generated in: #{options[:output]}"
puts "  - #{app}.yaml"
puts "  - #{app}-migration.yaml" if options[:job_suffix]
