#!/usr/bin/env ruby

# Standalone script to inspect what applications are running on all nodes
# Usage: ./bin/inspect-nodes

load File.join(File.dirname(__FILE__), '../lib/common.rb')

# Load global nodes
global_nodes_path = File.join(File.dirname(__FILE__), "../dist/nodes.json")
if !File.exist?(global_nodes_path)
    Util.exit_with_error("Nodes config not found at #{global_nodes_path}. Run ./generate-json.rb first.")
end

global_nodes = JSON.parse(IO.read(global_nodes_path))['nodes'].map { |n| n['uri'] }

puts ""
puts Util.underline("Discovering current state of all nodes")
puts ""

discovery = NodeDiscovery.new(global_nodes)
node_states = discovery.discover

# Display results in a clear format
node_states.each do |ns|
    puts "Node: #{ns.uri}"
    if ns.apps.empty?
        puts "  No applications running"
    else
        ns.apps.each do |app|
            status = app.healthy ? "healthy" : "DOWN"
            role = app.job_server ? " (job server)" : ""
            puts "  - #{app.name} (port #{app.port}): #{status}#{role}"
        end
    end
    puts ""
end

# Summary
puts Util.underline("Summary")
NodeDiscovery::KNOWN_APPS.each do |app_name, port|
    running_nodes = node_states.select { |ns| ns.running_app?(app_name) }
    healthy_nodes = node_states.select { |ns| ns.healthy_app?(app_name) }
    job_servers = node_states.select { |ns| ns.job_server_for?(app_name) }

    puts ""
    puts "#{app_name} (port #{port}):"
    puts "  Running on: #{running_nodes.length} node(s)"
    puts "  Healthy: #{healthy_nodes.length} node(s)"
    puts "  Job servers: #{job_servers.length} (#{job_servers.map(&:uri).join(', ')})"

    if healthy_nodes.length == 0 && running_nodes.length > 0
        puts Util.warning("  WARNING: All instances are unhealthy!")
    end
end

puts ""
