#!/usr/bin/env ruby

# Run this script from the project root directory

LOG = "/tmp/release-elm.log"

dir = File.dirname(__FILE__)
load File.join(dir, "../lib/common.rb")

helper = ReleaseHelper.new("elm")

# Turn elm.js -> elm.min.js
def add_suffix(filename, suffix)
  File.basename(filename, ".*") + ".#{suffix}" + File.extname(filename)
end

def ensure_elm_review
  if !File.exist?("review.sh")
    Util.exit_with_error("No review.sh script found")
  end

  puts "Running Elm Review"
  if !system("./review.sh")
    puts ""
    puts ""
    puts "Fix Elm Review Suggestions then release again"
    puts ""
    exit(1)
  end
end

def rewrite_constants(file, rewrites)
  contents = IO.read(file)
  rewrites.each do |r|
    contents.gsub!(r.from, r.to)
  end
  file = add_suffix(file, "constants")
  File.open(file, "w") do |out|
    out << contents
  end
  file
end

def rewrite_version(file, version)
  puts "rewrite_version #{file} #{version}"
  tmp = []
  version_found = false
  IO.readlines(file).each do |l|
    if !version_found && md = l.strip.match(/^version\s*:\s*"([^"]+)"/)
      tmp << l.sub(md[1], version)
      version_found = true
    else
      tmp << l
    end
  end
  if !version_found
    raise "Failed to find version in #{file}"
  end
  File.open(file, "w") do |out|
    out << tmp.join("")
  end
  file
end

def minify(helper, js)
  Util.assert_installed("uglifyjs", "https://github.com/mishoo/UglifyJS")
  file = add_suffix(js, "min")
  helper.run "uglifyjs #{js} --compress 'pure_funcs=[F2,F3,F4,F5,F6,F7,F8,F9,A2,A3,A4,A5,A6,A7,A8,A9],pure_getters,keep_fargs=false,unsafe_comps,unsafe' | uglifyjs --mangle --output #{file}"
  file
end

def extract_file(l, tag)
  if md = l.match(/#{tag}\s*=\s*\"([^\"]+)/)
    url = md[1]
    if url.match(/^\//)
      f = url[1..-1]
      if !File.exist?(f)
        raise "Failed to find file '#{f} from the following line in index.html:\n#{l}"
      end
      f
    else
      nil
    end
  else
    nil
  end
end

Util.assert_installed("elm")
ensure_elm_review
puts "Compiling"
a = "elm.js"
helper.run "elm make src/Main.elm --optimize --output=#{a}"
tag = Tag.ask

b = rewrite_constants(a, helper.app_config.rewrites)
c = minify(helper, b)
helper.run "rm -f #{b}"
helper.run "mv #{c} elm.js"

files = ["index.html"]
File.readlines("index.html").each do |l|
  if f = extract_file(l, "href")
    files << f
  end
  if f = extract_file(l, "src")
    files << f
  end
end

Dir.chdir(helper.release_dir) do |dir|
  helper.run "rm -rf *"
  helper.run "git reset --hard"
  helper.run "git clean -fdx"
  helper.write_to_file("version.txt", tag)
  files.each do |f|
    helper.run "cp #{File.join(helper.pwd, f)} ."
  end
  ni = rewrite_constants("index.html", helper.app_config.rewrites)
  ni2 = rewrite_version(ni, File.read("version.txt").strip)
  helper.run "rm -f index.html"
  helper.run "mv #{ni2} index.html"
  helper.run "git add #{files.join(" ")} version.txt"

  helper.maybe_tag_and_push(tag)
end

puts ""
