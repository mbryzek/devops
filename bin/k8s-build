#!/usr/bin/env ruby

# k8s-build: Build and push Docker images to DigitalOcean Container Registry
#
# Usage:
#   k8s-build [--app APP] [--version VERSION] [--push] [--no-cache]
#
# Examples:
#   k8s-build                                           # Build current app (inferred from directory)
#   k8s-build --app platform                            # Build platform
#   k8s-build --app platform --version v1.2.3 --push    # Build and push specific version
#
# Prerequisites:
#   - Docker installed and running
#   - doctl authenticated (for pushing to DOCR)

load File.join(File.dirname(__FILE__), '../lib/common.rb')

args = Args.parse(ARGV, ["app"])

# Registry configuration
REGISTRY = 'registry.digitalocean.com/bryzek'

# Valid applications and their source directories
APP_CONFIG = {
  'platform' => {
    source_dir: File.expand_path('~/code/platform'),
    dockerfile: 'Dockerfile'
  },
  'acumen' => {
    source_dir: File.expand_path('~/code/acumen/acumen'),
    dockerfile: 'Dockerfile'
  }
}

unless APP_CONFIG.key?(args.app)
  Util.exit_with_error("Invalid app '#{args.app}'. Valid apps: #{APP_CONFIG.keys.join(', ')}")
end

config = APP_CONFIG[args.app]

# Get version - ask for tag if not specified
version = args.version
unless version
  Dir.chdir(config[:source_dir]) do
    version = Tag.ask
    if version.empty?
      Util.exit_with_error("No tag available. Please specify --version")
    end
  end
end

source_dir = config[:source_dir]

# Verify source directory exists
unless File.directory?(source_dir)
  Util.exit_with_error("Source directory not found: #{source_dir}")
end

# Verify Dockerfile exists
dockerfile = File.join(source_dir, config[:dockerfile])
unless File.exist?(dockerfile)
  Util.exit_with_error("Dockerfile not found: #{dockerfile}\nPlease create a Dockerfile in #{source_dir}")
end

image_name = "#{REGISTRY}/#{args.app}"
image_tag = "#{image_name}:#{version}"
latest_tag = "#{image_name}:latest"

puts ""
puts "=" * 60
puts "Building Docker image"
puts "=" * 60
puts "  App:     #{args.app}"
puts "  Version: #{version}"
puts "  Source:  #{source_dir}"
puts "  Image:   #{image_tag}"
puts "=" * 60
puts ""

Dir.chdir(source_dir) do
  # Build image with version tag only
  cache_arg = args.no_cache ? '--no-cache' : ''
  Util.run("docker build #{cache_arg} -t #{image_tag} .")
end

puts ""
puts "Build successful!"
puts "  Image: #{image_tag}"

# Tag as latest after successful build
Util.run("docker tag #{image_tag} #{latest_tag}")
puts "  Tagged: #{latest_tag}"

if args.push
  puts ""
  puts "=" * 60
  puts "Pushing to registry"
  puts "=" * 60

  # Login to DOCR
  Util.run("doctl registry login")

  # Push both tags
  Util.run("docker push #{image_tag}")
  Util.run("docker push #{latest_tag}")

  puts ""
  puts "Push successful!"
  puts "  #{image_tag}"
  puts "  #{latest_tag}"
else
  puts ""
  puts "To push to registry, run with --push flag:"
  puts "  k8s-build --app #{args.app} --version #{version} --push"
end

puts ""
puts "Version: #{version}"
